{% extends 'base.html' %}
{% block content %}
<div class="container animate__animated animate__fadeIn">
    <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: #FF6B00;">Mon Panier üõí</h2>
        <p class="text-muted">Finalisez votre commande chez Offranel</p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div id="cart-list" class="mb-4">
                </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4 shadow-sm border-0 sticky-top" style="border-radius: 20px; border: 1px solid rgba(255,107,0,0.2); top: 90px;">
                <h5 class="fw-bold mb-4">R√©sum√© de la commande</h5>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Nombre d'articles</span>
                    <span id="cart-count-summary" class="fw-bold">0</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Livraison</span>
                    <span class="badge bg-success-subtle text-success rounded-pill">√Ä discuter sur WhatsApp</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-4">
                    <span class="fw-bold">Total Estim√©</span>
                    <h4 class="fw-bold text-orange text-end" id="total-price">0 $</h4>
                </div>

                <button onclick="checkout()" class="btn btn-orange w-100 py-3 fw-bold rounded-pill shadow-sm mb-3">
                    <i class="fab fa-whatsapp me-2"></i>COMMANDER MAINTENANT
                </button>

                <div class="text-center">
                    <p class="text-muted small mb-2"><i class="fas fa-shield-alt me-1"></i> Paiement s√©curis√© √† la livraison</p>
                    <a href="/" class="btn btn-link w-100 text-muted text-decoration-none small">
                        <i class="fas fa-arrow-left me-1"></i> Continuer mes achats
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CART_KEY = 'offranel_cart';
    const TAUX_ECHANGE = 2850; // MODIFIEZ ICI : 1$ = 2850 FC

    function renderCart() {
        const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        const list = document.getElementById('cart-list');
        const totalPriceEl = document.getElementById('total-price');
        const countEl = document.getElementById('cart-count-summary');

        if (cart.length === 0) {
            list.innerHTML = `
                <div class="text-center py-5 bg-white shadow-sm" style="border-radius: 20px;">
                    <i class="fas fa-shopping-basket fa-4x text-light mb-3"></i>
                    <h4 class="text-muted">Votre panier est vide üòï</h4>
                    <p class="small text-muted mb-4">D√©couvrez nos articles exclusifs pour remplir votre panier.</p>
                    <a href="/" class="btn btn-orange px-4 rounded-pill">Voir la boutique</a>
                </div>`;
            totalPriceEl.innerText = "0 $";
            countEl.innerText = "0";
            return;
        }

        let totalUSD = 0;
        let totalFC = 0;

        list.innerHTML = cart.map((item, index) => {
            const price = parseFloat(item.price) || 0;
            if (item.currency === "FC") {
                totalFC += price;
            } else {
                totalUSD += price;
            }

            return `
                <div class="card mb-3 p-3 border-0 shadow-sm rounded-4 animate__animated animate__fadeInUp">
                    <div class="d-flex align-items-center">
                        <img src="${item.image}" width="90" height="90" class="rounded-3 me-3" style="object-fit: cover; border: 1px solid #eee;">
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1 text-dark">${item.title}</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-orange fw-bold fs-5">${item.price} ${item.currency}</span>
                            </div>
                        </div>
                        <button onclick="removeItem(${index})" class="btn btn-light btn-sm text-danger rounded-circle p-2 shadow-sm" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        // Calcul de la conversion
        let conversionUSD = totalUSD + (totalFC / TAUX_ECHANGE);
        let conversionFC = totalFC + (totalUSD * TAUX_ECHANGE);

        totalPriceEl.innerHTML = `
            <div class="animate__animated animate__fadeIn">
                <span class="d-block">${conversionUSD.toFixed(2)} $</span>
                <small class="text-muted fw-normal d-block" style="font-size: 0.75rem;">
                    soit ${conversionFC.toLocaleString()} FC
                </small>
            </div>
        `;
        countEl.innerText = cart.length;
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        cart.splice(index, 1);
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        renderCart();

        if (typeof updateCartBadge === "function") {
            updateCartBadge();
        }
    }

    function checkout() {
        const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        if (cart.length === 0) return alert("Votre panier est vide !");

        let message = "üöÄ *NOUVELLE COMMANDE - OFFRANEL SHOP*\n";
        message += "----------------------------------------\n\n";

        let totalUSD = 0;
        let totalFC = 0;

        cart.forEach((item, i) => {
            message += `üì¶ *Article ${i+1}:* ${item.title}\n`;
            message += `üí∞ *Prix:* ${item.price} ${item.currency}\n`;
            message += `----------------------------------------\n`;

            const p = parseFloat(item.price) || 0;
            if (item.currency === "FC") totalFC += p; else totalUSD += p;
        });

        let finalUSD = totalUSD + (totalFC / TAUX_ECHANGE);
        let finalFC = totalFC + (totalUSD * TAUX_ECHANGE);

        message += `\nüíµ *TOTAL ESTIM√â :*\n`;
        message += `üëâ *${finalUSD.toFixed(2)} USD*\n`;
        message += `üëâ *${finalFC.toLocaleString()} FC*\n\n`;
        message += `üë§ *Client :* {{ session.get('name') }}\n`;
        message += `üìç _Taux : 1$ = ${TAUX_ECHANGE} FC_`;

        const encodedMessage = encodeURIComponent(message);
        const whatsappNumber = "243828035654";
        window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, '_blank');
    }

    document.addEventListener('DOMContentLoaded', renderCart);
</script>

<style>
    .text-orange { color: #FF6B00 !important; }
    .btn-orange { background: #FF6B00; color: white; border: none; }
    .btn-orange:hover { background: #e66000; color: white; }
    .bg-success-subtle { background-color: #d1e7dd; }
    .text-success { color: #0f5132 !important; }
    .card:hover { transform: translateY(-2px); transition: 0.3s; }
</style>
{% endblock %}