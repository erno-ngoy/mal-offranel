{% extends 'base.html' %}

{% block content %}
<div class="container animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark">Stats <span class="text-orange">Offranel üçä</span></h2>
            <p class="text-muted small">Vue d'ensemble de votre activit√© en temps r√©el.</p>
        </div>
        <span class="badge bg-success rounded-pill px-3 py-2 shadow-sm animate__animated animate__pulse animate__infinite">
            <i class="fas fa-circle me-1 small"></i> En direct
        </span>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4">
            <div class="glass-card text-center p-3 h-100 shadow-sm border-0">
                <div class="bg-orange-light rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 55px; height: 55px;">
                    <i class="fas fa-users text-orange fa-lg"></i>
                </div>
                <h3 class="fw-bold mb-0" id="stat-users">{{ stats.total_users|default(0) }}</h3>
                <p class="text-muted small mb-0">Utilisateurs</p>
            </div>
        </div>

        <div class="col-6 col-md-4">
            <div class="glass-card text-center p-3 h-100 shadow-sm border-0">
                <div class="bg-dark-light rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 55px; height: 55px; background: #f0f0f0;">
                    <i class="fas fa-box-open text-dark fa-lg"></i>
                </div>
                <h3 class="fw-bold mb-0" id="stat-products">{{ stats.total_products|default(0) }}</h3>
                <p class="text-muted small mb-0">Articles</p>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="glass-card text-center p-3 h-100 shadow-sm d-flex flex-column justify-content-center border-0" style="background: linear-gradient(145deg, #ffffff, #fff5ee);">
                <div class="d-flex align-items-center justify-content-center">
                    <span class="spinner-grow spinner-grow-sm text-success me-2"></span>
                    <h3 class="fw-bold mb-0" id="active-count">{{ stats.active_now|default(1) }}</h3>
                </div>
                <p class="text-muted small mb-0 fw-bold">Actif en ce moment</p>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4 shadow-sm border-0" style="border-left: 5px solid #FF6B00 !important; border-radius: 20px;">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-orange p-2 rounded-3 me-3">
                        <i class="fas fa-bullhorn text-white"></i>
                    </div>
                    <h5 class="fw-bold mb-0">Configuration du Pop-up (Annonce)</h5>
                </div>
                <p class="small text-muted mb-4">Ce message s'affichera automatiquement aux clients une seule fois toutes les 24 heures pour annoncer une promo ou une info importante.</p>

                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label small fw-bold text-dark">Titre du Pop-up</label>
                        <input type="text" id="adminPopTitle" class="form-control rounded-pill border-orange-light" value="{{ popup.title|default('')|forceescape }}" placeholder="Ex: Promotion de No√´l ! üéÑ">
                    </div>
                    <div class="col-md-7">
                        <label class="form-label small fw-bold text-dark">Message / Contenu</label>
                        <textarea id="adminPopContent" class="form-control rounded-4 border-orange-light" rows="2" placeholder="√âcrivez votre message ici...">{{ popup.content|default('')|forceescape }}</textarea>
                    </div>
                </div>

                <div class="d-flex flex-wrap align-items-center justify-content-between mt-4 gap-3">
                    <div class="form-check form-switch custom-switch">
                        <input class="form-check-input" type="checkbox" id="adminPopActive" {% if popup.active %}checked{% endif %}>
                        <label class="form-check-label fw-bold small text-muted" for="adminPopActive">Activer l'affichage pour les clients</label>
                    </div>
                    <button onclick="savePopup()" class="btn btn-orange rounded-pill px-5 fw-bold shadow-sm transition-all">
                        <i class="fas fa-save me-2"></i>Mettre √† jour l'annonce
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="glass-card p-4 shadow-sm border-0 h-100" style="border-radius: 20px;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0"><i class="fas fa-chart-pie me-2 text-orange"></i>R√©partition du Stock</h5>
                    <small class="text-muted">Proportion Users vs Produits</small>
                </div>
                <div style="height: 300px; position: relative;">
                    <canvas id="offranelChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="glass-card p-4 shadow-sm h-100 border-0" style="border-radius: 20px;">
                <h5 class="fw-bold mb-4">Actions Rapides</h5>
                <div class="d-grid gap-3">
                    <a href="/publier" class="btn btn-orange w-100 py-3 rounded-pill fw-bold shadow-sm">
                        <i class="fas fa-plus-circle me-2"></i>Nouveau Produit
                    </a>
                    <a href="/admin/modifier-a-propos" class="btn btn-outline-orange w-100 py-3 rounded-pill fw-bold">
                        <i class="fas fa-edit me-2"></i>Editer "√Ä Propos"
                    </a>
                    <button onclick="location.reload()" class="btn btn-light w-100 py-3 rounded-pill fw-bold border text-muted">
                        <i class="fas fa-sync-alt me-2"></i>Actualiser les stats
                    </button>
                    <hr class="my-2">
                    <p class="small text-muted text-center italic">Derni√®re mise √† jour : <br><strong>{% set d = stats.last_update if stats.last_update else 'Maintenant' %}{{ d }}</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // SAUVEGARDE DU POPUP
    async function savePopup() {
        const btn = document.querySelector('button[onclick="savePopup()"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>...';

        // En r√©cup√©rant .value via JS, les apostrophes sont g√©r√©es nativement.
        const data = {
            title: document.getElementById('adminPopTitle').value,
            content: document.getElementById('adminPopContent').value,
            active: document.getElementById('adminPopActive').checked
        };

        try {
            const res = await fetch('/admin/update_popup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                // JSON.stringify √©chappe automatiquement les caract√®res sp√©ciaux pour le transfert
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert("üì¢ Annonce enregistr√©e avec succ√®s !");
            } else {
                alert("Erreur lors de l'enregistrement.");
            }
        } catch (e) {
            alert("Erreur de connexion au serveur.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save me-2"></i>Mettre √† jour l\'annonce';
        }
    }

    // INITIALISATION DU GRAPHIQUE CORRIG√âE
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('offranelChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            const uCount = parseInt("{{ stats.total_users|default(0) }}") || 0;
            const pCount = parseInt("{{ stats.total_products|default(0) }}") || 0;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilisateurs', 'Produits'],
                    datasets: [{
                        data: [uCount, pCount],
                        backgroundColor: ['#FF6B00', '#1A1A1A'],
                        hoverOffset: 15,
                        borderWidth: 0,
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        setInterval(() => {
            const el = document.getElementById('active-count');
            if(el) {
                let current = parseInt(el.innerText);
                let change = Math.floor(Math.random() * 3) - 1;
                el.innerText = Math.max(1, current + change);
            }
        }, 8000);
    });
</script>

<style>
    .bg-orange-light { background-color: rgba(255, 107, 0, 0.1); }
    .border-orange-light { border: 1px solid rgba(255, 107, 0, 0.2) !important; }
    .glass-card { background: white; border-radius: 20px; transition: all 0.3s ease; }
    .glass-card:hover { transform: translateY(-3px); }
    .btn-orange { background-color: #FF6B00; color: white; border: none; }
    .btn-orange:hover { background-color: #e66000; color: white; transform: scale(1.02); }
    .btn-outline-orange { border: 2px solid #FF6B00; color: #FF6B00; }
    .btn-outline-orange:hover { background-color: #FF6B00; color: white; }
    .text-orange { color: #FF6B00; }
    .transition-all { transition: all 0.3s ease; }
    .form-check-input:checked { background-color: #FF6B00; border-color: #FF6B00; }
</style>
{% endblock %}