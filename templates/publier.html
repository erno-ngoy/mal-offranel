{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 glass-card p-5 bg-white shadow" style="border-radius: 25px; border: 2px solid #FF6B00;">
        <h2 class="fw-bold text-center mb-4" style="color: #FF6B00;">üì¶ Nouvelle Publication</h2>

        <form id="uploadForm">
            <div class="mb-3">
                <label class="fw-bold">Nom de l'article</label>
                <input type="text" id="title" class="form-control rounded-pill border-orange" required>
            </div>

            <div class="row">
                <div class="col-7 mb-3">
                    <label class="fw-bold">Prix</label>
                    <input type="number" id="price" class="form-control rounded-pill border-orange" required>
                </div>
                <div class="col-5 mb-3">
                    <label class="fw-bold">Devise</label>
                    <select id="currency" class="form-select rounded-pill border-orange">
                        <option value="USD">$ USD</option>
                        <option value="CDF">FC CDF</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label class="fw-bold">Photo üì∏</label>
                <input type="file" id="fileInput" class="form-control rounded-pill" accept="image/*" required>
            </div>

            <div class="mb-3">
                <label class="fw-bold">Description üìù</label>
                <textarea id="description" class="form-control rounded-4 border-orange" rows="3"></textarea>
            </div>

            <button type="submit" id="btnSubmit" class="btn btn-orange w-100 py-3 shadow rounded-pill fw-bold">
                Lancer la vente ! üöÄ
            </button>
        </form>

        <div id="loader" class="text-center mt-3 d-none">
            <div class="spinner-border text-orange"></div>
            <p>Traitement en cours...</p>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnSubmit');
    const loader = document.getElementById('loader');
    const file = document.getElementById('fileInput').files[0];

    btn.disabled = true;
    loader.classList.remove('d-none');

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    try {
        const imageText = await toBase64(file);
        const response = await fetch('/publier', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: document.getElementById('title').value,
                price: document.getElementById('price').value,
                currency: document.getElementById('currency').value,
                description: document.getElementById('description').value,
                photo_url: imageText
            })
        });
        if (response.ok) window.location.href = "/";
    } catch (err) {
        alert("Erreur de publication");
        btn.disabled = false;
        loader.classList.add('d-none');
    }
};
</script>
{% endblock %}