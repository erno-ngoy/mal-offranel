{% extends 'base.html' %}
{% block content %}
<div class="container animate__animated animate__fadeIn">
    <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: #FF6B00;">Mon Panier üõí</h2>
        <p class="text-muted">Finalisez votre commande chez Offranel</p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div id="cart-list" class="mb-4">
                </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4 shadow-sm border-0" style="border-radius: 20px; border: 1px solid rgba(255,107,0,0.2);">
                <h5 class="fw-bold mb-4">R√©sum√©</h5>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Nombre d'articles</span>
                    <span id="cart-count-summary" class="fw-bold">0</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-4">
                    <span class="fw-bold">Total Estim√©</span>
                    <h4 class="fw-bold text-orange" id="total-price">0 $</h4>
                </div>
                <button onclick="checkout()" class="btn btn-orange w-100 py-3 fw-bold rounded-pill shadow-sm">
                    <i class="fab fa-whatsapp me-2"></i>COMMANDER VIA WHATSAPP
                </button>
                <a href="/" class="btn btn-link w-100 text-muted mt-3 text-decoration-none small">
                    <i class="fas fa-arrow-left me-1"></i> Continuer mes achats
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Utilisation de la m√™me cl√© que dans index.html
    const CART_KEY = 'offranel_cart';

    function renderCart() {
        const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        const list = document.getElementById('cart-list');
        const totalPriceEl = document.getElementById('total-price');
        const countEl = document.getElementById('cart-count-summary');

        let total = 0;
        let currency = "$"; // Par d√©faut

        if (cart.length === 0) {
            list.innerHTML = `
                <div class="text-center py-5 bg-white shadow-sm" style="border-radius: 20px;">
                    <i class="fas fa-shopping-basket fa-3x text-light mb-3"></i>
                    <h4 class="text-muted">Le panier est vide üòï</h4>
                    <p class="small text-muted">Parcourez nos articles pour commencer vos achats.</p>
                </div>`;
            totalPriceEl.innerText = "0 $";
            countEl.innerText = "0";
            return;
        }

        list.innerHTML = cart.map((item, index) => {
            total += parseFloat(item.price);
            currency = item.currency; // Utilise la devise du dernier item ajout√©
            return `
                <div class="card mb-3 p-3 border-0 shadow-sm rounded-4 animate__animated animate__fadeInUp" style="transition: 0.3s;">
                    <div class="d-flex align-items-center">
                        <img src="${item.image}" width="90" height="90" class="rounded-3 me-3" style="object-fit: cover; border: 1px solid #eee;">
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1 text-dark">${item.title}</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-orange fw-bold fs-5">${item.price} ${item.currency}</span>
                            </div>
                        </div>
                        <button onclick="removeItem(${index})" class="btn btn-light btn-sm text-danger rounded-circle p-2" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        totalPriceEl.innerText = `${total} ${currency}`;
        countEl.innerText = cart.length;
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        cart.splice(index, 1);
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        renderCart();

        // Mettre √† jour le badge global dans base.html
        if (typeof updateCartBadge === "function") {
            updateCartBadge();
        }
    }

    function checkout() {
        const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        if (cart.length === 0) return alert("Votre panier est vide !");

        let message = "Bonjour Offranel Shop ! üçä\nJe souhaite commander les articles suivants :\n\n";
        let total = 0;
        let currency = "";

        cart.forEach((item, i) => {
            message += `${i+1}. *${item.title}* - ${item.price} ${item.currency}\n`;
            total += parseFloat(item.price);
            currency = item.currency;
        });

        message += `\n*Total : ${total} ${currency}*`;
        message += `\n\nClient : {{ session.get('name') }}`;

        const encodedMessage = encodeURIComponent(message);
        // Remplacez le num√©ro ci-dessous par votre num√©ro WhatsApp r√©el
        const whatsappNumber = "243828035654";
        window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, '_blank');
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', renderCart);
</script>

<style>
    .text-orange { color: #FF6B00 !important; }
    .btn-orange { background: #FF6B00; color: white; border: none; }
    .btn-orange:hover { background: #e66000; color: white; }
    .card:hover { transform: scale(1.01); }
</style>
{% endblock %}